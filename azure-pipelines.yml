# azure-pipelines.yml - Juice Shop (enforce Node 18, safe installs, frontend handling, Checkmarx)
trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  nodeVersion: '18.x'

stages:
- stage: BuildAndScan
  displayName: Build, Test & Scan
  jobs:
  - job: build
    displayName: Build and Scan Code
    steps:

    # ---------- Ensure correct Node version up-front ----------
    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'
      displayName: 'Use Node.js $(nodeVersion)'

    - script: |
        echo "=== Verify Node/NPM versions BEFORE any npm command ==="
        node -v
        npm -v
      displayName: 'Show Node and NPM versions (verification)'

    # ---------- Optional: install build tools (native modules) ----------
    - script: |
        sudo apt-get update
        sudo apt-get install -y build-essential python3
      displayName: 'Install build tools (for native modules)'

    # ---------- Ensure root package-lock.json exists ----------
    - script: |
        if [ ! -f package-lock.json ]; then
          echo "Creating root package-lock.json..."
          npm install --package-lock-only
        else
          echo "Root package-lock.json exists"
        fi
      displayName: 'Ensure root package-lock.json'

    # ---------- Cache npm ----------
    - task: Cache@2
      inputs:
        key: 'npm | "$(Agent.OS)" | package-lock.json'
        path: ~/.npm
      displayName: 'Cache npm (root)'

    # ---------- Install root dependencies reproducibly ----------
    - script: |
        echo "Installing root dependencies with npm ci..."
        npm ci
      displayName: 'Install root dependencies (npm ci)'

    # ---------- FRONTEND: if exists, install deps and run ngcc ----------
    - script: |
        if [ -d frontend ]; then
          echo "Switching to frontend folder and installing dependencies..."
          cd frontend
          if [ -f package-lock.json ]; then
            npm ci --legacy-peer-deps
          else
            npm install --legacy-peer-deps
            npm install --package-lock-only || true
          fi

          echo "Running ngcc via npx..."
          npx ngcc --tsconfig "./src/tsconfig.app.json" --first-only || true

          echo "Optional: build frontend if required..."
          npm run build || echo "Frontend build failed — continuing pipeline"
        else
          echo "No frontend folder found; skipping frontend steps."
        fi
      displayName: 'Install frontend deps, run ngcc and build'

    # ---------- Unit tests ----------
    - script: |
        echo "Running unit tests..."
        npm test || echo "Tests failed — continuing pipeline"
      displayName: 'Run unit tests (ignore failures)'

    # ---------- Security audit (non-blocking) ----------
    - script: |
        echo "Running npm audit (report only)..."
        npm audit --audit-level=moderate || true
      displayName: 'Run npm audit (no-fail)'

    # ---------- Checkmarx scan ----------
    - task: Checkmarx AST@3
      displayName: 'Run Checkmarx AST scan'
      inputs:
        CheckmarxService: 'juiceshop-connection'
        projectName: '$(Build.Repository.Name)'
        branchName: '$(Build.SourceBranchName)'
        tenantName: 'nfr_lugapel-ast'
